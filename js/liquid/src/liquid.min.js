/*
 * Copyright (c) 2012 Brandon Jones
 *
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any damages
 * arising from the use of this software.
 *
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 *
 *    1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software. If you use this software
 *    in a product, an acknowledgment in the product documentation would be
 *    appreciated but is not required.
 *
 *    2. Altered source versions must be plainly marked as such, and must not
 *    be misrepresented as being the original software.
 *
 *    3. This notice may not be removed or altered from any source
 *    distribution.
 */
/*
 ** Copyright (c) 2012 The Khronos Group Inc.
 **
 ** Permission is hereby granted, free of charge, to any person obtaining a
 ** copy of this software and/or associated documentation files (the
 ** "Materials"), to deal in the Materials without restriction, including
 ** without limitation the rights to use, copy, modify, merge, publish,
 ** distribute, sublicense, and/or sell copies of the Materials, and to
 ** permit persons to whom the Materials are furnished to do so, subject to
 ** the following conditions:
 **
 ** The above copyright notice and this permission notice shall be included
 ** in all copies or substantial portions of the Materials.
 **
 ** THE MATERIALS ARE PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 ** EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 ** MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 ** IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 ** CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 ** TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 ** MATERIALS OR THE USE OR OTHER DEALINGS IN THE MATERIALS.
 */
/*
 * Copyright (c) 2012 Brandon Jones, Colin MacKenzie IV
 *
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any damages
 * arising from the use of this software.
 *
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 *
 *    1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software. If you use this software
 *    in a product, an acknowledgment in the product documentation would be
 *    appreciated but is not required.
 *
 *    2. Altered source versions must be plainly marked as such, and must not
 *    be misrepresented as being the original software.
 *
 *    3. This notice may not be removed or altered from any source
 *    distribution.
 */
(function(h){function l(b){b=document.createEvent("CustomEvent");b.initCustomEvent("fullscreenchange",!0,!1,null);document.dispatchEvent(b)}function u(b){b=document.createEvent("CustomEvent");b.initCustomEvent("fullscreenerror",!0,!1,null);document.dispatchEvent(b)}function b(b){b=document.createEvent("CustomEvent");b.initCustomEvent("pointerlockchange",!0,!1,null);document.dispatchEvent(b)}function e(b){b=document.createEvent("CustomEvent");b.initCustomEvent("pointerlockerror",!0,!1,null);document.dispatchEvent(b)}
  var d=(h.HTMLElement||h.Element).prototype,f,m=h.GameShim={supports:{fullscreen:!0,pointerLock:!0,gamepad:!0,highResTimer:!0}};(function(){var b=0,e=["webkit","moz","ms","o"],d;for(d=0;d<e.length&&!window.requestAnimationFrame;++d)window.requestAnimationFrame=window[e[d]+"RequestAnimationFrame"];window.cancelAnimationFrame=window.cancelAnimationFrame||window.cancelRequestAnimationFrame;for(d=0;d<e.length&&!window.cancelAnimationFrame;++d)window.cancelAnimationFrame=window[e[d]+"CancelAnimationFrame"]||
    window[e[d]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(k,e){var d=Date.now(),f=Math.max(0,16-(d-b)),m=window.setTimeout(function(){k(d+f)},f);return b=d+f,m});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(b){clearTimeout(b)});window.animationStartTime||(f=function(){for(d=0;d<e.length;++d)if(window[e[d]+"AnimationStartTime"])return function(){return window[e[d]+"AnimationStartTime"]};return function(){return Date.now()}}(),
    Object.defineProperty(window,"animationStartTime",{enumerable:!0,configurable:!1,writeable:!1,get:f}))})();document.hasOwnProperty("fullscreenEnabled")||(f=function(){return"webkitIsFullScreen"in document?function(){return webkitRequestFullScreen in document}:"mozFullScreenEnabled"in document?function(){return document.mozFullScreenEnabled}:(m.supports.fullscreen=!1,function(){return!1})}(),Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,writeable:!1,get:f}));document.hasOwnProperty("fullscreenElement")||
  (f=function(){for(var b=0,e=["webkitCurrentFullScreenElement","webkitFullscreenElement","mozFullScreenElement"];b<e.length;b++)if(e[b]in document)return function(){return document[e[b]]};return function(){return null}}(),Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,writeable:!1,get:f}));document.addEventListener("webkitfullscreenchange",l,!1);document.addEventListener("mozfullscreenchange",l,!1);document.addEventListener("webkitfullscreenerror",u,!1);document.addEventListener("mozfullscreenerror",
    u,!1);d.requestFullscreen||(d.requestFullscreen=function(){return d.webkitRequestFullScreen?function(){this.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}:d.mozRequestFullScreen?function(){this.mozRequestFullScreen()}:function(){}}());document.exitFullscreen||(document.exitFullscreen=function(){return document.webkitExitFullscreen||document.mozCancelFullScreen||function(){}}());h=h.MouseEvent.prototype;"movementX"in h||Object.defineProperty(h,"movementX",{enumerable:!0,configurable:!1,writeable:!1,
    get:function(){return this.webkitMovementX||this.mozMovementX||0}});"movementY"in h||Object.defineProperty(h,"movementY",{enumerable:!0,configurable:!1,writeable:!1,get:function(){return this.webkitMovementY||this.mozMovementY||0}});navigator.pointer||(navigator.pointer=navigator.webkitPointer||navigator.mozPointer);document.addEventListener("webkitpointerlockchange",b,!1);document.addEventListener("webkitpointerlocklost",b,!1);document.addEventListener("mozpointerlockchange",b,!1);document.addEventListener("mozpointerlocklost",
    b,!1);document.addEventListener("webkitpointerlockerror",e,!1);document.addEventListener("mozpointerlockerror",e,!1);document.hasOwnProperty("pointerLockElement")||(f=function(){return"webkitPointerLockElement"in document?function(){return document.webkitPointerLockElement}:"mozPointerLockElement"in document?function(){return document.mozPointerLockElement}:function(){return null}}(),Object.defineProperty(document,"pointerLockElement",{enumerable:!0,configurable:!1,writeable:!1,get:f}));d.requestPointerLock||
  (d.requestPointerLock=function(){return d.webkitRequestPointerLock?function(){this.webkitRequestPointerLock()}:d.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:navigator.pointer?function(){navigator.pointer.lock(this,b,e)}:(m.supports.pointerLock=!1,function(){})}());document.exitPointerLock||(document.exitPointerLock=function(){return document.webkitExitPointerLock||document.mozExitPointerLock||function(){navigator.pointer&&navigator.pointer.unlock()}}());navigator.gamepads||(f=function(){if("webkitGamepads"in
    navigator)return function(){return navigator.webkitGamepads};if("mozGamepads"in navigator)return function(){return navigator.mozGamepads};m.supports.gamepad=!1;var b=[];return function(){return b}}(),Object.defineProperty(navigator,"gamepads",{enumerable:!0,configurable:!1,writeable:!1,get:f}));window.performance||(window.performance={});window.performance.timing||(window.performance.timing={navigationStart:Date.now()});window.performance.now||(window.performance.now=function(){return window.performance.webkitNow?
    window.performance.webkitNow:(m.supports.highResTimer=!1,function(){return Date.now()-window.performance.timing.navigationStart})}())})("undefined"!=typeof exports?global:window);define("game-shim",function(){});
define("engine/loader",["require","exports","module"],function(h,l,u){function b(b){this.root=b||"";this.resources={}}return b.prototype={load:function(b,d,f,m){function k(b,k){r.resources[b]=k;h--;0===h?d&&d(r):m&&m(l,h,C)}function e(b,k){h--;C++;r.resources[b]=null;k.src=b;f&&f(r,k)}for(var h=0,l=0,C=0,r=this,n=0;n<b.length;n++){var x=b[n];x in this.resources||(h++,l++,/\.(jpe?g|gif|png)$/.test(x)?this._loadImage(x,k,e):/\.(og(g|a)|mp3)$/.test(x)?this._loadAudio(x,k,e):/\.json$/.test(x)?this._loadJSON(x,
  k,e):/\.(bin|raw)/.test(x)?this._loadBin(x,k,e):this._loadData(x,k,e))}0===h&&d?window.setTimeout(function(){d(this)},1):m&&m(l,h,C)},_loadImage:function(b,d,f){var e=document.createElement("img");e.onload=function(){d(b,e)};e.onerror=function(k){f(b,k)};e.src=this.root+b},_loadJSON:function(b,d,f){var e=new XMLHttpRequest;e.open("GET",b,!0);e.onload=function(){try{var k=JSON.parse(this.response);d(b,k)}catch(H){f(b,H)}};e.onerror=function(k){k(b,k)};e.send()},_loadBin:function(b,d,f){f=new XMLHttpRequest;
  f.open("GET",b,!0);f.responseType="arraybuffer";f.onload=function(e){d(b,this.response)};f.onerror=function(e){e(b,e)};f.send()},_loadData:function(b,d,f){f=new XMLHttpRequest;f.open("GET",b,!0);f.onload=function(e){d(b,this.response)};f.onerror=function(e){e(b,e)};f.send()},_success:function(b,d){},_error:function(b,d){}},b});
define("engine/clock",["require","exports","module"],function(h,l,u){var b=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame;l.Clock=function(){this.running=!1;this.interval=null;this.t0=this.now();this.t=0;this.maxdt=.25};l.Clock.prototype={tick:function(){var b=this.now(),d=(b-this.t0)/1E3;this.t0=b;this.t+=d;d<this.maxdt&&0<d&&this.ontick(d)},start:function(e){this.running=!0;var d=this,f;b?b(f=function(){d.tick();
  d.running&&b(f,e)},e):this.interval=window.setInterval(function(){d.tick()},1);this.t0=this.now()},stop:function(){this.interval&&(window.clearInterval(this.interval),this.interval=null);this.running=!1},now:function(){return window.performance.now()},ontick:function(b){}};l.fixedstep=function(b,d,f){var e=0,k=0;return function(m){for(e+=m;e>=b;)d(b,k),e-=b,m-=b,k+=b;f(m,k)}}});
define("engine/utils",["require","exports","module"],function(h,l,u){l.extend=function(){var b=arguments[0],e,d;for(e=1;e<arguments.length;e++){var f=arguments[e];for(d in f)b[d]=f[d]}return b};l.debounce=function(b,e){function d(){b.apply(k,f)}var f,m,k;return function(){k=this;f=arguments;clearTimeout(m);m=setTimeout(d,e)}};l.clamp=function(b,e,d){return b<e?e:b>d?d:b};l.getHashValue=function(b,e){var d=window.location.hash.match("[#,]+"+b+"(=([^,]*))?");return d?3==d.length&&null!=d[2]?d[2]:!0:
  e}});
define("engine/input",["require","exports","module","engine/utils"],function(h,l,u){var b=h("engine/utils").clamp;h=navigator.userAgent.toLowerCase();var e=/mobile|android|ip(ad|od|hone)|windows phone/.test(h),d=function(b,e){return function(){return b.apply(e,arguments)}};l.Handler=function(b){this.mouseMove=d(this.mouseMove,this);this.mouseDown=d(this.mouseDown,this);this.mouseUp=d(this.mouseUp,this);this.deviceOrientation=d(this.deviceOrientation,this);this.touchMove=d(this.touchMove,this);this.touchStart=
  d(this.touchStart,this);this.touchEnd=d(this.touchEnd,this);this.targetElement=b;this.offset={x:0,y:0};this.mouse={down:!1,x:0,y:0};this.orientation={x:0,y:0,z:0};this.height=this.width=0;this.reset()};l.Handler.prototype={addEvent:function(){this.updateOffset();e?(window.addEventListener("deviceorientation",this.deviceOrientation),document.addEventListener("touchmove",this.touchMove),this.targetElement.addEventListener("touchstart",this.touchStart),this.targetElement.addEventListener("touchend",
  this.touchEnd)):(document.addEventListener("mousemove",this.mouseMove),this.targetElement.addEventListener("mousedown",this.mouseDown),this.targetElement.addEventListener("mouseup",this.mouseUp))},removeEvent:function(){this.updateOffset();e?(window.removeEventListener("deviceorientation",this.deviceOrientation),document.removeEventListener("touchmove",this.touchMove),this.targetElement.removeEventListener("touchstart",this.touchStart),this.targetElement.removeEventListener("touchend",this.touchEnd)):
  (document.removeEventListener("mousemove",this.mouseMove),this.targetElement.removeEventListener("mousedown",this.mouseDown),this.targetElement.removeEventListener("mouseup",this.mouseUp))},updateOffset:function(){var b=this.targetElement.getBoundingClientRect();this.width=b.width;this.height=b.height;this.offset={x:b.left,y:b.top,px:0,py:0}},reset:function(){this.mouse={down:!1,x:0,y:0}},deviceOrientation:function(b){this.orientation.x=b.beta;this.orientation.y=b.gamma;this.orientation.z=b.alpha},
  touchStart:function(b){b=b.touches[0];this.mouse.down=!0;this.mouse.x=b.clientX-this.offset.x;this.mouse.y=b.clientY-this.offset.y},touchEnd:function(){this.mouse.down=!1;this.hasFocus&&this.onClick&&this.onClick(this.mouse.x,this.mouse.y)},touchMove:function(b){b=b.touches[0];this.mouse.x=b.clientX-this.offset.x;this.mouse.y=b.clientY-this.offset.y},mouseDown:function(){this.mouse.down=!0},mouseUp:function(){this.mouse.down=!1;this.hasFocus&&this.onClick&&this.onClick(this.mouse.x,this.mouse.y)},
  mouseMove:function(e){var d=e.clientY;this.mouse.x=b(e.clientX-this.offset.x,0,this.width);this.mouse.y=b(d-this.offset.y,0,this.height)}}});
define("engine/gl/shader",["require","exports","module"],function(h,l,u){function b(b,d,f){this.gl=b;this.program=this.makeProgram(d,f);this.uniformLocations={};this.uniformValues={};this.uniformNames=[];this.attributeLocations={}}b.prototype={use:function(){this.gl.useProgram(this.program)},prepareUniforms:function(b){var d=[],e;for(e in b)d.push(e);this.uniformNames=d;for(b=0;b<this.uniformNames.length;b++)d=this.uniformNames[b],this.uniformLocations[d]=this.gl.getUniformLocation(this.program,d)},
  uniforms:function(b){0===this.uniformNames.length&&this.prepareUniforms(b);for(var d=0;d<this.uniformNames.length;d++){var e=this.uniformNames[d],m=this.uniformLocations[e],k=b[e];if(null!==m)if(k.uniform)k.equals(this.uniformValues[e])||(k.uniform(m),k.set(this.uniformValues,e));else if(k.length){var h=this.uniformValues[e];if(void 0!==h){for(var e=0,l=k.length;e<l&&k[e]==h[e];e++);if(e!=l)for(e=0,l=k.length;e<l;e++)h[e]=k[e]}else this.uniformValues[e]=new Float32Array(k);switch(k.length){case 2:this.gl.uniform2fv(m,
    k);break;case 3:this.gl.uniform3fv(m,k);break;case 4:this.gl.uniform4fv(m,k);break;case 9:this.gl.uniformMatrix3fv(m,!1,k);break;case 16:this.gl.uniformMatrix4fv(m,!1,k)}}else k!=this.uniformValues[e]&&(this.gl.uniform1f(m,k),this.uniformValues[e]=k)}},getUniformLocation:function(b){return void 0===this.uniformLocations[b]&&(this.uniformLocations[b]=this.gl.getUniformLocation(this.program,b)),this.uniformLocations[b]},getAttribLocation:function(b){if(!(b in this.attributeLocations)){var e=this.gl.getAttribLocation(this.program,
    b);if(0>e)throw"undefined attribute "+b;this.attributeLocations[b]=e}return this.attributeLocations[b]},makeShader:function(b,d){var e=this.gl.createShader(b);this.gl.shaderSource(e,d);this.gl.compileShader(e);if(!this.gl.getShaderParameter(e,this.gl.COMPILE_STATUS))throw console.log(this.gl.getShaderInfoLog(e),b,d),'Compiler exception: "'+this.gl.getShaderInfoLog(e)+'"';return e},makeProgram:function(b,d){var e=this.makeShader(this.gl.VERTEX_SHADER,b),m=this.makeShader(this.gl.FRAGMENT_SHADER,d),
    k=this.gl.createProgram();this.gl.attachShader(k,e);this.gl.attachShader(k,m);this.gl.linkProgram(k);if(!this.gl.getProgramParameter(k,this.gl.LINK_STATUS))throw"Linker exception: "+this.gl.getProgramInfoLog(k);return k}};l.Shader=b;l.Manager=function(b,d,f){this.gl=b;this.resources=d;this.shaders=[];f=f||{};this.prefix=f.prefix||"/js/liquid/shaders/"};l.Manager.prototype={includeExpression:/#include "([^"]+)"/g,preprocess:function(b,d){return d.replace(this.includeExpression,function(b,e){return this.getSource(e)}.bind(this))},
  getSource:function(b){var e=this.resources[this.prefix+b];if(null==e)throw"shader not found: "+b;return this.preprocess(b,e)},get:function(e,d){d||(d=e);d+=".frag";e+=".vertex";var f=d+";"+e;return f in this.shaders||(this.shaders[f]=new b(this.gl,this.getSource(e),this.getSource(d))),this.shaders[f]}}});
define("engine/gl/geometry",["require","exports","module"],function(h,l,u){l.grid=function(b){for(var e=new Float32Array(b*b*18),d=0,f=0;f<b;f++)for(var m=0;m<b;m++)e[d++]=m/b,e[d++]=0,e[d++]=f/b,e[d++]=m/b,e[d++]=0,e[d++]=(f+1)/b,e[d++]=(m+1)/b,e[d++]=0,e[d++]=(f+1)/b,e[d++]=m/b,e[d++]=0,e[d++]=f/b,e[d++]=(m+1)/b,e[d++]=0,e[d++]=(f+1)/b,e[d++]=(m+1)/b,e[d++]=0,e[d++]=f/b;return e};l.wireFrame=function(b){for(var e=new Float32Array(2*b.length),d=b.length/9,f=0;f<d;f++)for(var m=0;3>m;m++)for(var k=
  (m+1)%3,h=0;3>h;h++)e[18*f+3*m+h]=b[9*f+3*m+h],e[18*f+3*m+9+h]=b[9*f+3*k+h];return e};l.screen_quad=function(b,e){return b=b||1,e=e||b,new Float32Array([-b,e,0,-b,-e,0,b,-e,0,-b,e,0,b,-e,0,b,e,0])};l.cube=function(b){return b=b||1,new Float32Array([b,b,b,b,-b,b,-b,-b,b,b,b,b,-b,-b,b,-b,b,b,-b,b,-b,-b,-b,-b,b,b,-b,b,b,-b,-b,-b,-b,b,-b,-b,-b,b,b,-b,-b,-b,-b,b,-b,-b,b,b,-b,-b,b,-b,-b,-b,b,b,b,b,b,-b,b,-b,-b,b,b,b,b,-b,-b,b,-b,b,b,b,b,-b,b,b,-b,b,-b,b,b,-b,b,b,b,-b,b,-b,-b,-b,-b,-b,-b,b,b,-b,b,-b,-b,
  -b,b,-b,b,b,-b,-b])}});
define("engine/gl/texture",["require","exports","module","../utils"],function(h,l,u){h=h("../utils").extend;l.Texture2D=function(b,e,d){this.gl=b;this.texture=b.createTexture();this.unit=-1;this.bound=!1;this.bindTexture();b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);b.pixelStorei(b.UNPACK_COLORSPACE_CONVERSION_WEBGL,b.NONE);b.texImage2D(b.TEXTURE_2D,0,d.internalformat||d.format||b.RGBA,d.format||b.RGBA,d.type||b.UNSIGNED_BYTE,e);b.texParameteri(b.TEXTURE_2D,
  b.TEXTURE_MAG_FILTER,d.mag_filter||b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,d.min_filter||b.LINEAR_MIPMAP_LINEAR);b.texParameterf(b.TEXTURE_2D,b.TEXTURE_WRAP_S,d.wrap_s||b.REPEAT);b.texParameterf(b.TEXTURE_2D,b.TEXTURE_WRAP_T,d.wrap_t||b.REPEAT);!1!==d.mipmap&&b.generateMipmap(b.TEXTURE_2D)};l.Texture2D.prototype={bindTexture:function(b){void 0!==b&&(this.gl.activeTexture(this.gl.TEXTURE0+b),this.unit=b);this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture);this.bound=!0},unbindTexture:function(){this.gl.activeTexture(this.gl.TEXTURE0+
  this.unit);this.gl.bindTexture(this.gl.TEXTURE_2D,null);this.unit=-1;this.bound=!1},uniform:function(b){this.gl.uniform1i(b,this.unit)},equals:function(b){return this.unit===b},set:function(b,e){b[e]=this.unit}};l.FBO=function(b,e,d,f,h){this.width=e;this.height=d;this.gl=b;this.framebuffer=b.createFramebuffer();b.bindFramebuffer(b.FRAMEBUFFER,this.framebuffer);this.texture=b.createTexture();b.bindTexture(b.TEXTURE_2D,this.texture);b.texImage2D(b.TEXTURE_2D,0,h||b.RGBA,e,d,0,h||b.RGBA,f||b.UNSIGNED_BYTE,
  null);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);this.depth=b.createRenderbuffer();b.bindRenderbuffer(b.RENDERBUFFER,this.depth);b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,e,d);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.texture,0);b.framebufferRenderbuffer(b.FRAMEBUFFER,
  b.DEPTH_ATTACHMENT,b.RENDERBUFFER,this.depth);this.supported=b.checkFramebufferStatus(b.FRAMEBUFFER)===b.FRAMEBUFFER_COMPLETE;b.bindTexture(b.TEXTURE_2D,null);b.bindRenderbuffer(b.RENDERBUFFER,null);b.bindFramebuffer(b.FRAMEBUFFER,null);this.unit=-1};l.FBO.prototype=h({},l.Texture2D.prototype,{bind:function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.framebuffer)},unbind:function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}})});
define("engine/gl/mesh",["require","exports","module"],function(h,l,u){h=function(e,d){this.gl=e;this.ibo=d.ibo;this.vbo=d.vbo||new b(e,d.vertex);this.mode=d.mode||e.TRIANGLES;if(this.ibo)switch(this.ibo.byteLength/this.ibo.length){case 1:this.iboType=e.UNSIGNED_BYTE;break;case 2:this.iboType=e.UNSIGNED_SHORT;break;case 4:this.iboType=e.UNSIGNED_LONG;break;default:this.iboType=e.UNSIGNED_SHORT}else this.iboType=0;this.setAttributes(d.attributes)};h.prototype={setAttributes:function(b){var e=Object.keys(b);
  this.attributes=[];for(var f=this.vertexSize=0;f<e.length;f++){var h=e[f],k=b[h],h={name:h,size:k.size||3,type:k.type||this.gl.FLOAT,stride:k.stride||0,offset:k.offset||0,normalized:!!k.normalized};this.vertexSize+=h.size;this.attributes.push(h)}},bindAttributes:function(b){for(var e=0;e<this.attributes.length;e++){var f=this.attributes[e],h=b.getAttribLocation(f.name);this.gl.enableVertexAttribArray(h);this.gl.vertexAttribPointer(h,f.size,f.type,f.normalized,f.stride,f.offset)}},draw:function(b){b.use();
  this.vbo.bind();this.bindAttributes(b);this.ibo?(this.ibo.bind(),this.gl.drawElements(this.mode,this.ibo.length,this.iboType,0)):this.gl.drawArrays(this.mode,0,this.vbo.length/this.vertexSize);this.vbo.unbind()}};l.Mesh=h;var b=function(b,d,f,h){this.gl=b;this.target=f||b.ARRAY_BUFFER;this.buffer=b.createBuffer();this.bind();b.bufferData(b.ARRAY_BUFFER,d,h||b.STATIC_DRAW);this.unbind();this.length=d.length;this.btyeLength=d.byteLength};b.prototype={bind:function(){this.gl.bindBuffer(this.target,this.buffer)},
  unbind:function(){this.gl.bindBuffer(this.target,null)},free:function(b){this.gl.deleteBuffer(this.buffer);delete this.buffer}};l.Buffer=b});
WebGLDebugUtils=function(){function h(b){if(null==m){m={};for(var k in b)"number"==typeof b[k]&&(m[b[k]]=k)}}function l(){if(null==m)throw"WebGLDebugUtils.init(ctx) not called";}function u(b){l();var k=m[b];return void 0!==k?k:"*UNKNOWN WebGL ENUM (0x"+b.toString(16)+")"}function b(b,e,d){b=f[b];return void 0!==b&&b[e]?u(d):null===d?"null":void 0===d?"undefined":d.toString()}function e(b,e,d){b.__defineGetter__(d,function(){return e[d]});b.__defineSetter__(d,function(b){e[d]=b})}function d(b){var e=
  b.getParameter(b.MAX_VERTEX_ATTRIBS),d=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,d);for(var k=0;k<e;++k)b.disableVertexAttribArray(k),b.vertexAttribPointer(k,4,b.FLOAT,!1,0,0),b.vertexAttrib1f(k,0);b.deleteBuffer(d);e=b.getParameter(b.MAX_TEXTURE_IMAGE_UNITS);for(k=0;k<e;++k)b.activeTexture(b.TEXTURE0+k),b.bindTexture(b.TEXTURE_CUBE_MAP,null),b.bindTexture(b.TEXTURE_2D,null);b.activeTexture(b.TEXTURE0);b.useProgram(null);b.bindBuffer(b.ARRAY_BUFFER,null);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);
  b.bindFramebuffer(b.FRAMEBUFFER,null);b.bindRenderbuffer(b.RENDERBUFFER,null);b.disable(b.BLEND);b.disable(b.CULL_FACE);b.disable(b.DEPTH_TEST);b.disable(b.DITHER);b.disable(b.SCISSOR_TEST);b.blendColor(0,0,0,0);b.blendEquation(b.FUNC_ADD);b.blendFunc(b.ONE,b.ZERO);b.clearColor(0,0,0,0);b.clearDepth(1);b.clearStencil(-1);b.colorMask(!0,!0,!0,!0);b.cullFace(b.BACK);b.depthFunc(b.LESS);b.depthMask(!0);b.depthRange(0,1);b.frontFace(b.CCW);b.hint(b.GENERATE_MIPMAP_HINT,b.DONT_CARE);b.lineWidth(1);b.pixelStorei(b.PACK_ALIGNMENT,
    4);b.pixelStorei(b.UNPACK_ALIGNMENT,4);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);b.UNPACK_COLORSPACE_CONVERSION_WEBGL&&b.pixelStorei(b.UNPACK_COLORSPACE_CONVERSION_WEBGL,b.BROWSER_DEFAULT_WEBGL);b.polygonOffset(0,0);b.sampleCoverage(1,!1);b.scissor(0,0,b.canvas.width,b.canvas.height);b.stencilFunc(b.ALWAYS,0,4294967295);b.stencilMask(4294967295);b.stencilOp(b.KEEP,b.KEEP,b.KEEP);b.viewport(0,0,b.canvas.width,b.canvas.height);for(b.clear(b.COLOR_BUFFER_BIT|
    b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT);b.getError(););}var f={enable:{0:!0},disable:{0:!0},getParameter:{0:!0},drawArrays:{0:!0},drawElements:{0:!0,2:!0},createShader:{0:!0},getShaderParameter:{1:!0},getProgramParameter:{1:!0},getVertexAttrib:{1:!0},vertexAttribPointer:{2:!0},bindTexture:{0:!0},activeTexture:{0:!0},getTexParameter:{0:!0,1:!0},texParameterf:{0:!0,1:!0},texParameteri:{0:!0,1:!0,2:!0},texImage2D:{0:!0,2:!0,6:!0,7:!0},texSubImage2D:{0:!0,6:!0,7:!0},copyTexImage2D:{0:!0,2:!0},copyTexSubImage2D:{0:!0},
  generateMipmap:{0:!0},bindBuffer:{0:!0},bufferData:{0:!0,2:!0},bufferSubData:{0:!0},getBufferParameter:{0:!0,1:!0},pixelStorei:{0:!0,1:!0},readPixels:{4:!0,5:!0},bindRenderbuffer:{0:!0},bindFramebuffer:{0:!0},checkFramebufferStatus:{0:!0},framebufferRenderbuffer:{0:!0,1:!0,2:!0},framebufferTexture2D:{0:!0,1:!0,2:!0},getFramebufferAttachmentParameter:{0:!0,1:!0,2:!0},getRenderbufferParameter:{0:!0,1:!0},renderbufferStorage:{0:!0,1:!0},clear:{0:!0},depthFunc:{0:!0},blendFunc:{0:!0,1:!0},blendFuncSeparate:{0:!0,
    1:!0,2:!0,3:!0},blendEquation:{0:!0},blendEquationSeparate:{0:!0,1:!0},stencilFunc:{0:!0},stencilFuncSeparate:{0:!0,1:!0},stencilMaskSeparate:{0:!0},stencilOp:{0:!0,1:!0,2:!0},stencilOpSeparate:{0:!0,1:!0,2:!0,3:!0},cullFace:{0:!0},frontFace:{0:!0}},m=null;return{init:h,mightBeEnum:function(b){return l(),void 0!==m[b]},glEnumToString:u,glFunctionArgToString:b,glFunctionArgsToString:function(e,d){for(var k="",f=0;f<d.length;++f)k+=(0==f?"":", ")+b(e,f,d[f]);return k},makeDebugContext:function(d,f,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     m){function k(b,e){return function(){m&&m(e,arguments);var d=b[e].apply(b,arguments),k=b.getError();return 0!=k&&(l[k]=!0,f(k,e,arguments)),d}}h(d);f=f||function(e,d,k){for(var f="",a=0;a<k.length;++a)f+=(0==a?"":", ")+b(d,a,k[a]);e="WebGL error "+u(e)+" in "+d+"("+f+")";window.console&&window.console.error?window.console.error(e):window.console&&window.console.log&&window.console.log(e)};var l={},r={},n;for(n in d)"function"==typeof d[n]?r[n]=k(d,n):e(r,d,n);return r.getError=function(){for(var b in l)if(l.hasOwnProperty(b)&&
  l[b])return l[b]=!1,b;return d.NO_ERROR},r},makeLostContextSimulatingCanvas:function(b){function f(a){return"function"==typeof a?a:function(c){a.handleEvent(c)}}function k(){for(var a=Object.keys(E),c=0;c<a.length;++c)delete E[a]}function h(){++z;c||p==z&&b.loseContext()}function m(a,g){var b=a[g];return function(){h();if(!c)return b.apply(a,arguments)}}function l(a){return{statusMessage:a,preventDefault:function(){O=!0}}}function n(b){for(var p in b)"function"==typeof b[p]?t[p]=m(b,p):e(t,b,p);t.getError=
  function(){var a;h();if(!c)for(;a=x.getError();)E[a]=!0;for(a in E)if(E[a])return delete E[a],a;return t.NO_ERROR};for(var z="createBuffer createFramebuffer createProgram createRenderbuffer createShader createTexture".split(" "),d=0;d<z.length;++d)p=z[d],t[p]=function(p){return function(){h();if(c)return null;var z=p.apply(b,arguments);return z.__webglDebugContextLostId__=a,g.push(z),z}}(b[p]);z="getActiveAttrib getActiveUniform getBufferParameter getContextAttributes getAttachedShaders getFramebufferAttachmentParameter getParameter getProgramParameter getProgramInfoLog getRenderbufferParameter getShaderParameter getShaderInfoLog getShaderSource getTexParameter getUniform getUniformLocation getVertexAttrib".split(" ");
  for(d=0;d<z.length;++d)p=z[d],t[p]=function(a){return function(){return h(),c?null:a.apply(b,arguments)}}(t[p]);z="isBuffer isEnabled isFramebuffer isProgram isRenderbuffer isShader isTexture".split(" ");for(d=0;d<z.length;++d)p=z[d],t[p]=function(a){return function(){return h(),c?!1:a.apply(b,arguments)}}(t[p]);return t.checkFramebufferStatus=function(a){return function(){return h(),c?t.FRAMEBUFFER_UNSUPPORTED:a.apply(b,arguments)}}(t.checkFramebufferStatus),t.getAttribLocation=function(a){return function(){return h(),
    c?-1:a.apply(b,arguments)}}(t.getAttribLocation),t.getVertexAttribOffset=function(a){return function(){return h(),c?0:a.apply(b,arguments)}}(t.getVertexAttribOffset),t.isContextLost=function(){return c},t}var x,q=[],u=[];var t={};var a=1,c=!1,g=[],p=0,z=0,O=!1,w=0,E={};b.getContext=function(a){return function(){var c=a.apply(b,arguments);if(c instanceof WebGLRenderingContext){if(c!=x){if(x)throw"got different context";x=c;t=n(x)}return t}return c}}(b.getContext);return function(a){var c=a.addEventListener;
  a.addEventListener=function(g,b,p){switch(g){case "webglcontextlost":q.push(f(b));break;case "webglcontextrestored":u.push(f(b));break;default:c.apply(a,arguments)}}}(b),b.loseContext=function(){if(!c){c=!0;p=0;for(++a;x.getError(););k();E[x.CONTEXT_LOST_WEBGL]=!0;var g=l("context lost"),z=q.slice();setTimeout(function(){for(var a=0;a<z.length;++a)z[a](g);0<=w&&setTimeout(function(){b.restoreContext()},w)},0)}},b.restoreContext=function(){c&&u.length&&setTimeout(function(){if(!O)throw"can not restore. webglcontestlost listener did not call event.preventDefault";
  for(var a=0;a<g.length;++a){var b=g[a];b instanceof WebGLBuffer?x.deleteBuffer(b):b instanceof WebGLFramebuffer?x.deleteFramebuffer(b):b instanceof WebGLProgram?x.deleteProgram(b):b instanceof WebGLRenderbuffer?x.deleteRenderbuffer(b):b instanceof WebGLShader?x.deleteShader(b):b instanceof WebGLTexture&&x.deleteTexture(b)}d(x);c=!1;z=0;O=!1;for(var a=u.slice(),b=l("context restored"),p=0;p<a.length;++p)a[p](b)},0)},b.loseContextInNCalls=function(a){if(c)throw"You can not ask a lost contet to be lost";
  p=z+a},b.getNumCalls=function(){return z},b.setRestoreTimeout=function(a){w=a},b},resetToInitialState:d}}();define("engine/gl/_webgl-debug",function(){});
define("engine/gl/context","require exports module ./mesh ./texture ../utils ./shader ./_webgl-debug".split(" "),function(h,l,u){function b(b,d,e){window.console&&window.console.error&&console.error(e,d)}var e=h("./mesh"),d=h("./texture"),f=h("../utils").extend,m=h("./shader");h("./_webgl-debug");l.Context=function(b,d){this.gl=b;this.resources=d;this.shaderManager=new m.Manager(d)};l.Context.prototype={getBuffer:function(b,d,f){new e.Buffer(this.gl,this.resources[b],d,f)},getFBO:function(){},getTexture:function(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      e){return new d.Texture2D(this.gl,this.resources[b],e)},getShader:function(b){}};l.initialize=function(d,e,h){h=h||b;if(d.getContext){var k=f({alpha:!1,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1},e.context),m=e.extensions||{},l=d.getContext("webgl",k);if(null==l&&(l=d.getContext("experimental-webgl",k),null==l)){h(d,"webgl is not supported by your browser. Try upgrading to the latest version of firefox or chrome.","no-webgl");return}if(e.vertex_texture_units&&
  l.getParameter(l.MAX_VERTEX_TEXTURE_IMAGE_UNITS)<e.vertex_texture_units)h(d,"This application needs at least two vertex texture units which are not supported by your browser. Try upgrading to the latest version of firefox or chrome.","no-vertext-texture-units");else if(m.texture_float&&null==l.getExtension("OES_texture_float"))h(d,"This application needs float textures which is not supported by your browser. Try upgrading to the latest version of firefox or chrome.","no-OES_texture_float");else return m.standard_derivatives&&
  null==l.getExtension("OES_standard_derivatives")&&h(d,"This application need the standard deriviates extensions for WebGL which is not supported by your Browser.Try upgrading to the latest version of firefox or chrome.","no-OES_standard_derivatives"),window.WebGLDebugUtils&&e.debug&&(e.log_all?l=WebGLDebugUtils.makeDebugContext(l,void 0,function(){console.log.apply(console,arguments)}):l=WebGLDebugUtils.makeDebugContext(l),console.log("running in debug context")),k.depth?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),
  l.enable(l.CULL_FACE),l.lost=!1,d.addEventListener("webglcontextlost",function(){h(d,"Lost webgl context!","context-lost");l.lost=!0},!1),l}else h(d,"canvas is not supported by your browser. Try upgrading to the latest version of firefox or chrome.","no-canvas")}});
(function(h,l){"object"==typeof exports?module.exports=l(global):"function"==typeof define&&define.amd?define("gl-matrix",[],function(){return l(h)}):l(h)})(this,function(h){function l(a){return e=a,e}function u(){return e="undefined"!=typeof Float32Array?Float32Array:Array,e}var b={};(function(){if("undefined"!=typeof Float32Array){var a=new Float32Array(1),c=new Int32Array(a.buffer);b.invsqrt=function(g){a[0]=g;c[0]=1597463007-(c[0]>>1);var b=a[0];return b*(1.5-.5*g*b*b)}}else b.invsqrt=function(a){return 1/
  Math.sqrt(a)}})();var e=null;u();var d={create:function(a){var c=new e(3);return a?(c[0]=a[0],c[1]=a[1],c[2]=a[2]):c[0]=c[1]=c[2]=0,c},createFrom:function(a,c,g){var b=new e(3);return b[0]=a,b[1]=c,b[2]=g,b},set:function(a,c){return c[0]=a[0],c[1]=a[1],c[2]=a[2],c},equal:function(a,c){return a===c||1E-6>Math.abs(a[0]-c[0])&&1E-6>Math.abs(a[1]-c[1])&&1E-6>Math.abs(a[2]-c[2])},add:function(a,c,g){return g&&a!==g?(g[0]=a[0]+c[0],g[1]=a[1]+c[1],g[2]=a[2]+c[2],g):(a[0]+=c[0],a[1]+=c[1],a[2]+=c[2],a)},
  subtract:function(a,c,g){return g&&a!==g?(g[0]=a[0]-c[0],g[1]=a[1]-c[1],g[2]=a[2]-c[2],g):(a[0]-=c[0],a[1]-=c[1],a[2]-=c[2],a)},multiply:function(a,c,g){return g&&a!==g?(g[0]=a[0]*c[0],g[1]=a[1]*c[1],g[2]=a[2]*c[2],g):(a[0]*=c[0],a[1]*=c[1],a[2]*=c[2],a)},negate:function(a,c){return c||(c=a),c[0]=-a[0],c[1]=-a[1],c[2]=-a[2],c},scale:function(a,c,g){return g&&a!==g?(g[0]=a[0]*c,g[1]=a[1]*c,g[2]=a[2]*c,g):(a[0]*=c,a[1]*=c,a[2]*=c,a)},normalize:function(a,c){c||(c=a);var g=a[0],b=a[1],z=a[2],d=Math.sqrt(g*
    g+b*b+z*z);return d?1===d?(c[0]=g,c[1]=b,c[2]=z,c):(d=1/d,c[0]=g*d,c[1]=b*d,c[2]=z*d,c):(c[0]=0,c[1]=0,c[2]=0,c)},cross:function(a,c,g){g||(g=a);var b=a[0],z=a[1];a=a[2];var d=c[0],e=c[1];c=c[2];return g[0]=z*c-a*e,g[1]=a*d-b*c,g[2]=b*e-z*d,g},length:function(a){var c=a[0],g=a[1];a=a[2];return Math.sqrt(c*c+g*g+a*a)},squaredLength:function(a){var c=a[0],g=a[1];a=a[2];return c*c+g*g+a*a},dot:function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]},direction:function(a,c,g){g||(g=a);var b=a[0]-c[0],d=a[1]-
    c[1];a=a[2]-c[2];return(c=Math.sqrt(b*b+d*d+a*a))?(c=1/c,g[0]=b*c,g[1]=d*c,g[2]=a*c,g):(g[0]=0,g[1]=0,g[2]=0,g)},lerp:function(a,c,b,p){return p||(p=a),p[0]=a[0]+b*(c[0]-a[0]),p[1]=a[1]+b*(c[1]-a[1]),p[2]=a[2]+b*(c[2]-a[2]),p},dist:function(a,c){var b=c[0]-a[0],p=c[1]-a[1],d=c[2]-a[2];return Math.sqrt(b*b+p*p+d*d)}},f=null,m=new e(4);d.unproject=function(a,c,b,p,d){d||(d=a);f||(f=r.create());var g=f;return m[0]=2*(a[0]-p[0])/p[2]-1,m[1]=2*(a[1]-p[1])/p[3]-1,m[2]=2*a[2]-1,m[3]=1,r.multiply(b,c,g),
  r.inverse(g)?(r.multiplyVec4(g,m),0===m[3]?null:(d[0]=m[0]/m[3],d[1]=m[1]/m[3],d[2]=m[2]/m[3],d)):null};var k=d.createFrom(1,0,0),H=d.createFrom(0,1,0),Q=d.createFrom(0,0,1),D=d.create();d.rotationTo=function(a,c,b){b||(b=n.create());var g=d.dot(a,c);if(1<=g)n.set(x,b);else if(-.999999>g)d.cross(k,a,D),1E-6>d.length(D)&&d.cross(H,a,D),1E-6>d.length(D)&&d.cross(Q,a,D),d.normalize(D),n.fromAngleAxis(Math.PI,D,b);else{var g=Math.sqrt(2*(1+g)),z=1/g;d.cross(a,c,D);b[0]=D[0]*z;b[1]=D[1]*z;b[2]=D[2]*z;
  b[3]=.5*g;n.normalize(b)}return 1<b[3]?b[3]=1:-1>b[3]&&(b[3]=-1),b};d.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"};var C={create:function(a){var c=new e(9);return a?(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[8]=a[8]):c[0]=c[1]=c[2]=c[3]=c[4]=c[5]=c[6]=c[7]=c[8]=0,c},createFrom:function(a,c,b,p,d,O,w,E,f){var g=new e(9);return g[0]=a,g[1]=c,g[2]=b,g[3]=p,g[4]=d,g[5]=O,g[6]=w,g[7]=E,g[8]=f,g},determinant:function(a){var c=a[3],b=a[4],p=a[5],d=a[6],
  e=a[7],w=a[8];return a[0]*(w*b-p*e)+a[1]*(-w*c+p*d)+a[2]*(e*c-b*d)},inverse:function(a,c){var b=a[0],p=a[1],d=a[2],e=a[3],w=a[4],E=a[5],f=a[6],h=a[7],k=a[8],l=k*w-E*h,m=-k*e+E*f,B=h*e-w*f,y=b*l+p*m+d*B,v;return y?(v=1/y,c||(c=C.create()),c[0]=l*v,c[1]=(-k*p+d*h)*v,c[2]=(E*p-d*w)*v,c[3]=m*v,c[4]=(k*b-d*f)*v,c[5]=(-E*b+d*e)*v,c[6]=B*v,c[7]=(-h*b+p*f)*v,c[8]=(w*b-p*e)*v,c):null},multiply:function(a,c,b){b||(b=a);var g=a[0],d=a[1],e=a[2],w=a[3],f=a[4],h=a[5],k=a[6],S=a[7];a=a[8];var l=c[0],m=c[1],B=c[2],
  y=c[3],v=c[4],V=c[5],n=c[6],t=c[7];c=c[8];return b[0]=l*g+m*w+B*k,b[1]=l*d+m*f+B*S,b[2]=l*e+m*h+B*a,b[3]=y*g+v*w+V*k,b[4]=y*d+v*f+V*S,b[5]=y*e+v*h+V*a,b[6]=n*g+t*w+c*k,b[7]=n*d+t*f+c*S,b[8]=n*e+t*h+c*a,b},multiplyVec2:function(a,c,b){b||(b=c);var g=c[0];c=c[1];return b[0]=g*a[0]+c*a[3]+a[6],b[1]=g*a[1]+c*a[4]+a[7],b},multiplyVec3:function(a,c,b){b||(b=c);var g=c[0],d=c[1];c=c[2];return b[0]=g*a[0]+d*a[3]+c*a[6],b[1]=g*a[1]+d*a[4]+c*a[7],b[2]=g*a[2]+d*a[5]+c*a[8],b},set:function(a,c){return c[0]=a[0],
  c[1]=a[1],c[2]=a[2],c[3]=a[3],c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[8]=a[8],c},equal:function(a,c){return a===c||1E-6>Math.abs(a[0]-c[0])&&1E-6>Math.abs(a[1]-c[1])&&1E-6>Math.abs(a[2]-c[2])&&1E-6>Math.abs(a[3]-c[3])&&1E-6>Math.abs(a[4]-c[4])&&1E-6>Math.abs(a[5]-c[5])&&1E-6>Math.abs(a[6]-c[6])&&1E-6>Math.abs(a[7]-c[7])&&1E-6>Math.abs(a[8]-c[8])},identity:function(a){return a||(a=C.create()),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},transpose:function(a,c){if(!c||a===c){var b=
  a[1],p=a[2],d=a[5];return a[1]=a[3],a[2]=a[6],a[3]=b,a[5]=a[7],a[6]=p,a[7]=d,a}return c[0]=a[0],c[1]=a[3],c[2]=a[6],c[3]=a[1],c[4]=a[4],c[5]=a[7],c[6]=a[2],c[7]=a[5],c[8]=a[8],c},toMat4:function(a,c){return c||(c=r.create()),c[15]=1,c[14]=0,c[13]=0,c[12]=0,c[11]=0,c[10]=a[8],c[9]=a[7],c[8]=a[6],c[7]=0,c[6]=a[5],c[5]=a[4],c[4]=a[3],c[3]=0,c[2]=a[2],c[1]=a[1],c[0]=a[0],c},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+"]"}},r={create:function(a){var c=
  new e(16);return a&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]),c},createFrom:function(a,c,b,p,d,O,w,f,h,k,l,m,n,B,y,v){var g=new e(16);return g[0]=a,g[1]=c,g[2]=b,g[3]=p,g[4]=d,g[5]=O,g[6]=w,g[7]=f,g[8]=h,g[9]=k,g[10]=l,g[11]=m,g[12]=n,g[13]=B,g[14]=y,g[15]=v,g},set:function(a,c){return c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[8]=
  a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15],c},equal:function(a,c){return a===c||1E-6>Math.abs(a[0]-c[0])&&1E-6>Math.abs(a[1]-c[1])&&1E-6>Math.abs(a[2]-c[2])&&1E-6>Math.abs(a[3]-c[3])&&1E-6>Math.abs(a[4]-c[4])&&1E-6>Math.abs(a[5]-c[5])&&1E-6>Math.abs(a[6]-c[6])&&1E-6>Math.abs(a[7]-c[7])&&1E-6>Math.abs(a[8]-c[8])&&1E-6>Math.abs(a[9]-c[9])&&1E-6>Math.abs(a[10]-c[10])&&1E-6>Math.abs(a[11]-c[11])&&1E-6>Math.abs(a[12]-c[12])&&1E-6>Math.abs(a[13]-c[13])&&1E-6>
  Math.abs(a[14]-c[14])&&1E-6>Math.abs(a[15]-c[15])},identity:function(a){return a||(a=r.create()),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},transpose:function(a,c){if(!c||a===c){var b=a[1],p=a[2],d=a[3],e=a[6],w=a[7],f=a[11];return a[1]=a[4],a[2]=a[8],a[3]=a[12],a[4]=b,a[6]=a[9],a[7]=a[13],a[8]=p,a[9]=e,a[11]=a[14],a[12]=d,a[13]=w,a[14]=f,a}return c[0]=a[0],c[1]=a[4],c[2]=a[8],c[3]=a[12],c[4]=a[1],c[5]=a[5],c[6]=a[9],c[7]=
  a[13],c[8]=a[2],c[9]=a[6],c[10]=a[10],c[11]=a[14],c[12]=a[3],c[13]=a[7],c[14]=a[11],c[15]=a[15],c},determinant:function(a){var c=a[0],b=a[1],p=a[2],d=a[3],e=a[4],w=a[5],f=a[6],h=a[7],k=a[8],l=a[9],m=a[10],n=a[11],B=a[12],y=a[13],v=a[14];a=a[15];return B*l*f*d-k*y*f*d-B*w*m*d+e*y*m*d+k*w*v*d-e*l*v*d-B*l*p*h+k*y*p*h+B*b*m*h-c*y*m*h-k*b*v*h+c*l*v*h+B*w*p*n-e*y*p*n-B*b*f*n+c*y*f*n+e*b*v*n-c*w*v*n-k*w*p*a+e*l*p*a+k*b*f*a-c*l*f*a-e*b*m*a+c*w*m*a},inverse:function(a,c){c||(c=a);var b=a[0],p=a[1],d=a[2],
  e=a[3],w=a[4],f=a[5],h=a[6],k=a[7],l=a[8],m=a[9],n=a[10],B=a[11],y=a[12],v=a[13],t=a[14],x=a[15],r=b*f-p*w,T=b*h-d*w,q=b*k-e*w,A=p*h-d*f,u=p*k-e*f,C=d*k-e*h,G=l*v-m*y,J=l*t-n*y,K=l*x-B*y,D=m*t-n*v,I=m*x-B*v,M=n*x-B*t,N=r*M-T*I+q*D+A*K-u*J+C*G,F;return N?(F=1/N,c[0]=(f*M-h*I+k*D)*F,c[1]=(-p*M+d*I-e*D)*F,c[2]=(v*C-t*u+x*A)*F,c[3]=(-m*C+n*u-B*A)*F,c[4]=(-w*M+h*K-k*J)*F,c[5]=(b*M-d*K+e*J)*F,c[6]=(-y*C+t*q-x*T)*F,c[7]=(l*C-n*q+B*T)*F,c[8]=(w*I-f*K+k*G)*F,c[9]=(-b*I+p*K-e*G)*F,c[10]=(y*u-v*q+x*r)*F,c[11]=
  (-l*u+m*q-B*r)*F,c[12]=(-w*D+f*J-h*G)*F,c[13]=(b*D-p*J+d*G)*F,c[14]=(-y*A+v*T-t*r)*F,c[15]=(l*A-m*T+n*r)*F,c):null},toRotationMat:function(a,c){return c||(c=r.create()),c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=0,c[13]=0,c[14]=0,c[15]=1,c},toMat3:function(a,c){return c||(c=C.create()),c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[4],c[4]=a[5],c[5]=a[6],c[6]=a[8],c[7]=a[9],c[8]=a[10],c},toInverseMat3:function(a,c){var b=
  a[0],p=a[1],d=a[2],e=a[4],w=a[5],f=a[6],h=a[8],k=a[9],l=a[10],m=l*w-f*k,n=-l*e+f*h,B=k*e-w*h,y=b*m+p*n+d*B,v;return y?(v=1/y,c||(c=C.create()),c[0]=m*v,c[1]=(-l*p+d*k)*v,c[2]=(f*p-d*w)*v,c[3]=n*v,c[4]=(l*b-d*h)*v,c[5]=(-f*b+d*e)*v,c[6]=B*v,c[7]=(-k*b+p*h)*v,c[8]=(w*b-p*e)*v,c):null},multiply:function(a,c,b){b||(b=a);var g=a[0],d=a[1],e=a[2],w=a[3],f=a[4],h=a[5],k=a[6],l=a[7],m=a[8],n=a[9],B=a[10],y=a[11],v=a[12],t=a[13],x=a[14];a=a[15];var r=c[0],q=c[1],u=c[2],A=c[3];return b[0]=r*g+q*f+u*m+A*v,b[1]=
  r*d+q*h+u*n+A*t,b[2]=r*e+q*k+u*B+A*x,b[3]=r*w+q*l+u*y+A*a,r=c[4],q=c[5],u=c[6],A=c[7],b[4]=r*g+q*f+u*m+A*v,b[5]=r*d+q*h+u*n+A*t,b[6]=r*e+q*k+u*B+A*x,b[7]=r*w+q*l+u*y+A*a,r=c[8],q=c[9],u=c[10],A=c[11],b[8]=r*g+q*f+u*m+A*v,b[9]=r*d+q*h+u*n+A*t,b[10]=r*e+q*k+u*B+A*x,b[11]=r*w+q*l+u*y+A*a,r=c[12],q=c[13],u=c[14],A=c[15],b[12]=r*g+q*f+u*m+A*v,b[13]=r*d+q*h+u*n+A*t,b[14]=r*e+q*k+u*B+A*x,b[15]=r*w+q*l+u*y+A*a,b},multiplyVec3:function(a,c,b){b||(b=c);var g=c[0],d=c[1];c=c[2];return b[0]=a[0]*g+a[4]*d+a[8]*
  c+a[12],b[1]=a[1]*g+a[5]*d+a[9]*c+a[13],b[2]=a[2]*g+a[6]*d+a[10]*c+a[14],b},multiplyVec4:function(a,c,b){b||(b=c);var g=c[0],d=c[1],e=c[2];c=c[3];return b[0]=a[0]*g+a[4]*d+a[8]*e+a[12]*c,b[1]=a[1]*g+a[5]*d+a[9]*e+a[13]*c,b[2]=a[2]*g+a[6]*d+a[10]*e+a[14]*c,b[3]=a[3]*g+a[7]*d+a[11]*e+a[15]*c,b},translate:function(a,c,b){var g=c[0],d=c[1];c=c[2];var e,w,f,h,k,l,m,n,B,y,v,r;return b&&a!==b?(e=a[0],w=a[1],f=a[2],h=a[3],k=a[4],l=a[5],m=a[6],n=a[7],B=a[8],y=a[9],v=a[10],r=a[11],b[0]=e,b[1]=w,b[2]=f,b[3]=
  h,b[4]=k,b[5]=l,b[6]=m,b[7]=n,b[8]=B,b[9]=y,b[10]=v,b[11]=r,b[12]=e*g+k*d+B*c+a[12],b[13]=w*g+l*d+y*c+a[13],b[14]=f*g+m*d+v*c+a[14],b[15]=h*g+n*d+r*c+a[15],b):(a[12]=a[0]*g+a[4]*d+a[8]*c+a[12],a[13]=a[1]*g+a[5]*d+a[9]*c+a[13],a[14]=a[2]*g+a[6]*d+a[10]*c+a[14],a[15]=a[3]*g+a[7]*d+a[11]*c+a[15],a)},scale:function(a,c,b){var g=c[0],d=c[1];c=c[2];return b&&a!==b?(b[0]=a[0]*g,b[1]=a[1]*g,b[2]=a[2]*g,b[3]=a[3]*g,b[4]=a[4]*d,b[5]=a[5]*d,b[6]=a[6]*d,b[7]=a[7]*d,b[8]=a[8]*c,b[9]=a[9]*c,b[10]=a[10]*c,b[11]=
  a[11]*c,b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b):(a[0]*=g,a[1]*=g,a[2]*=g,a[3]*=g,a[4]*=d,a[5]*=d,a[6]*=d,a[7]*=d,a[8]*=c,a[9]*=c,a[10]*=c,a[11]*=c,a)},rotate:function(a,c,b,d){var g=b[0],e=b[1];b=b[2];var p=Math.sqrt(g*g+e*e+b*b),f,h,k,l,m,n,r,y,v,q,t,x,u,C,A,D,H,G,J,K,U,I,M,N;return p?(1!==p&&(p=1/p,g*=p,e*=p,b*=p),f=Math.sin(c),h=Math.cos(c),k=1-h,l=a[0],m=a[1],n=a[2],r=a[3],y=a[4],v=a[5],q=a[6],t=a[7],x=a[8],u=a[9],C=a[10],A=a[11],D=g*g*k+h,H=e*g*k+b*f,G=b*g*k-e*f,J=g*e*k-b*f,K=e*e*
  k+h,U=b*e*k+g*f,I=g*b*k+e*f,M=e*b*k-g*f,N=b*b*k+h,d?a!==d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]):d=a,d[0]=l*D+y*H+x*G,d[1]=m*D+v*H+u*G,d[2]=n*D+q*H+C*G,d[3]=r*D+t*H+A*G,d[4]=l*J+y*K+x*U,d[5]=m*J+v*K+u*U,d[6]=n*J+q*K+C*U,d[7]=r*J+t*K+A*U,d[8]=l*I+y*M+x*N,d[9]=m*I+v*M+u*N,d[10]=n*I+q*M+C*N,d[11]=r*I+t*M+A*N,d):null},rotateX:function(a,c,b){var g=Math.sin(c);c=Math.cos(c);var d=a[4],e=a[5],w=a[6],f=a[7],h=a[8],k=a[9],l=a[10],m=a[11];return b?a!==b&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],
  b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]):b=a,b[4]=d*c+h*g,b[5]=e*c+k*g,b[6]=w*c+l*g,b[7]=f*c+m*g,b[8]=d*-g+h*c,b[9]=e*-g+k*c,b[10]=w*-g+l*c,b[11]=f*-g+m*c,b},rotateY:function(a,c,b){var g=Math.sin(c);c=Math.cos(c);var d=a[0],e=a[1],f=a[2],h=a[3],k=a[8],l=a[9],m=a[10],n=a[11];return b?a!==b&&(b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]):b=a,b[0]=d*c+k*-g,b[1]=e*c+l*-g,b[2]=f*c+m*-g,b[3]=h*c+n*-g,b[8]=d*g+k*c,b[9]=e*g+l*c,b[10]=f*g+m*c,b[11]=h*g+n*
  c,b},rotateZ:function(a,c,b){var g=Math.sin(c);c=Math.cos(c);var d=a[0],e=a[1],f=a[2],h=a[3],k=a[4],l=a[5],m=a[6],n=a[7];return b?a!==b&&(b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]):b=a,b[0]=d*c+k*g,b[1]=e*c+l*g,b[2]=f*c+m*g,b[3]=h*c+n*g,b[4]=d*-g+k*c,b[5]=e*-g+l*c,b[6]=f*-g+m*c,b[7]=h*-g+n*c,b},frustum:function(a,c,b,d,e,f,h){h||(h=r.create());var g=c-a,p=d-b,k=f-e;return h[0]=2*e/g,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2*e/p,h[6]=0,h[7]=0,h[8]=(c+a)/g,
  h[9]=(d+b)/p,h[10]=-(f+e)/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-(f*e*2)/k,h[15]=0,h},perspective:function(a,c,b,d,e){a=b*Math.tan(a*Math.PI/360);c*=a;return r.frustum(-c,c,-a,a,b,d,e)},ortho:function(a,c,b,d,e,h,f){f||(f=r.create());var g=c-a,p=d-b,k=h-e;return f[0]=2/g,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=2/p,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=-2/k,f[11]=0,f[12]=-(a+c)/g,f[13]=-(d+b)/p,f[14]=-(h+e)/k,f[15]=1,f},lookAt:function(a,c,b,d){d||(d=r.create());var g,e,p,f,h,k,l,m,n,q,y=a[0],v=a[1];a=a[2];var t=
  b[0],x=b[1];b=b[2];var u=c[0],C=c[1];c=c[2];return y===u&&v===C&&a===c?r.identity(d):(l=y-u,m=v-C,n=a-c,q=1/Math.sqrt(l*l+m*m+n*n),l*=q,m*=q,n*=q,g=x*n-b*m,e=b*l-t*n,p=t*m-x*l,q=Math.sqrt(g*g+e*e+p*p),q?(q=1/q,g*=q,e*=q,p*=q):(g=0,e=0,p=0),f=m*p-n*e,h=n*g-l*p,k=l*e-m*g,q=Math.sqrt(f*f+h*h+k*k),q?(q=1/q,f*=q,h*=q,k*=q):(f=0,h=0,k=0),d[0]=g,d[1]=f,d[2]=l,d[3]=0,d[4]=e,d[5]=h,d[6]=m,d[7]=0,d[8]=p,d[9]=k,d[10]=n,d[11]=0,d[12]=-(g*y+e*v+p*a),d[13]=-(f*y+h*v+k*a),d[14]=-(l*y+m*v+n*a),d[15]=1,d)},fromRotationTranslation:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  c,b){b||(b=r.create());var g=a[0],d=a[1],e=a[2],f=a[3],h=g+g,k=d+d,l=e+e;a=g*h;var m=g*k,g=g*l,n=d*k,d=d*l,e=e*l,h=f*h,k=f*k,f=f*l;return b[0]=1-(n+e),b[1]=m+f,b[2]=g-k,b[3]=0,b[4]=m-f,b[5]=1-(a+e),b[6]=d+h,b[7]=0,b[8]=g+k,b[9]=d-h,b[10]=1-(a+n),b[11]=0,b[12]=c[0],b[13]=c[1],b[14]=c[2],b[15]=1,b},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+"]"}},n={create:function(a){var c=
  new e(4);return a?(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3]):c[0]=c[1]=c[2]=c[3]=0,c},createFrom:function(a,c,b,d){var g=new e(4);return g[0]=a,g[1]=c,g[2]=b,g[3]=d,g},set:function(a,c){return c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c},equal:function(a,c){return a===c||1E-6>Math.abs(a[0]-c[0])&&1E-6>Math.abs(a[1]-c[1])&&1E-6>Math.abs(a[2]-c[2])&&1E-6>Math.abs(a[3]-c[3])},identity:function(a){return a||(a=n.create()),a[0]=0,a[1]=0,a[2]=0,a[3]=1,a}},x=n.identity();n.calculateW=function(a,c){var b=a[0],
  d=a[1],e=a[2];return c&&a!==c?(c[0]=b,c[1]=d,c[2]=e,c[3]=-Math.sqrt(Math.abs(1-b*b-d*d-e*e)),c):(a[3]=-Math.sqrt(Math.abs(1-b*b-d*d-e*e)),a)};n.dot=function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]+a[3]*c[3]};n.inverse=function(a,c){var b=a[0],d=a[1],e=a[2],f=a[3],b=(b=b*b+d*d+e*e+f*f)?1/b:0;return c&&a!==c?(c[0]=-a[0]*b,c[1]=-a[1]*b,c[2]=-a[2]*b,c[3]=a[3]*b,c):(a[0]*=-b,a[1]*=-b,a[2]*=-b,a[3]*=b,a)};n.conjugate=function(a,c){return c&&a!==c?(c[0]=-a[0],c[1]=-a[1],c[2]=-a[2],c[3]=a[3],c):(a[0]*=
  -1,a[1]*=-1,a[2]*=-1,a)};n.length=function(a){var c=a[0],b=a[1],d=a[2];a=a[3];return Math.sqrt(c*c+b*b+d*d+a*a)};n.normalize=function(a,c){c||(c=a);var b=a[0],d=a[1],e=a[2],f=a[3],h=Math.sqrt(b*b+d*d+e*e+f*f);return 0===h?(c[0]=0,c[1]=0,c[2]=0,c[3]=0,c):(h=1/h,c[0]=b*h,c[1]=d*h,c[2]=e*h,c[3]=f*h,c)};n.add=function(a,c,b){return b&&a!==b?(b[0]=a[0]+c[0],b[1]=a[1]+c[1],b[2]=a[2]+c[2],b[3]=a[3]+c[3],b):(a[0]+=c[0],a[1]+=c[1],a[2]+=c[2],a[3]+=c[3],a)};n.multiply=function(a,c,b){b||(b=a);var g=a[0],d=
  a[1],e=a[2];a=a[3];var f=c[0],h=c[1],k=c[2];c=c[3];return b[0]=g*c+a*f+d*k-e*h,b[1]=d*c+a*h+e*f-g*k,b[2]=e*c+a*k+g*h-d*f,b[3]=a*c-g*f-d*h-e*k,b};n.multiplyVec3=function(a,b,g){g||(g=b);var c=b[0],d=b[1],e=b[2];b=a[0];var f=a[1],h=a[2];a=a[3];var k=a*c+f*e-h*d,l=a*d+h*c-b*e,m=a*e+b*d-f*c,c=-b*c-f*d-h*e;return g[0]=k*a+c*-b+l*-h-m*-f,g[1]=l*a+c*-f+m*-b-k*-h,g[2]=m*a+c*-h+k*-f-l*-b,g};n.scale=function(a,b,g){return g&&a!==g?(g[0]=a[0]*b,g[1]=a[1]*b,g[2]=a[2]*b,g[3]=a[3]*b,g):(a[0]*=b,a[1]*=b,a[2]*=b,
  a[3]*=b,a)};n.toMat3=function(a,b){b||(b=C.create());var c=a[0],d=a[1],e=a[2],f=a[3],h=c+c,k=d+d,l=e+e,m=c*h,n=c*k,c=c*l,q=d*k,d=d*l,e=e*l,h=f*h,k=f*k,f=f*l;return b[0]=1-(q+e),b[1]=n+f,b[2]=c-k,b[3]=n-f,b[4]=1-(m+e),b[5]=d+h,b[6]=c+k,b[7]=d-h,b[8]=1-(m+q),b};n.toMat4=function(a,b){b||(b=r.create());var c=a[0],d=a[1],e=a[2],f=a[3],h=c+c,k=d+d,l=e+e,m=c*h,n=c*k,c=c*l,q=d*k,d=d*l,e=e*l,h=f*h,k=f*k,f=f*l;return b[0]=1-(q+e),b[1]=n+f,b[2]=c-k,b[3]=0,b[4]=n-f,b[5]=1-(m+e),b[6]=d+h,b[7]=0,b[8]=c+k,b[9]=
  d-h,b[10]=1-(m+q),b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,b};n.slerp=function(a,b,d,e){e||(e=a);var c=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3],g,f,h,k;return 1<=Math.abs(c)?(e!==a&&(e[0]=a[0],e[1]=a[1],e[2]=a[2],e[3]=a[3]),e):(g=Math.acos(c),f=Math.sqrt(1-c*c),.001>Math.abs(f)?(e[0]=.5*a[0]+.5*b[0],e[1]=.5*a[1]+.5*b[1],e[2]=.5*a[2]+.5*b[2],e[3]=.5*a[3]+.5*b[3],e):(h=Math.sin((1-d)*g)/f,k=Math.sin(d*g)/f,e[0]=a[0]*h+b[0]*k,e[1]=a[1]*h+b[1]*k,e[2]=a[2]*h+b[2]*k,e[3]=a[3]*h+b[3]*k,e))};n.fromRotationMatrix=
  function(a,b){b||(b=n.create());var c=a[0]+a[4]+a[8];if(0<c){var d=Math.sqrt(c+1);b[3]=.5*d;d=.5/d;b[0]=(a[7]-a[5])*d;b[1]=(a[2]-a[6])*d;b[2]=(a[3]-a[1])*d}else{d=n.fromRotationMatrix.s_iNext=n.fromRotationMatrix.s_iNext||[1,2,0];c=0;a[4]>a[0]&&(c=1);a[8]>a[3*c+c]&&(c=2);var e=d[c],f=d[e];d=Math.sqrt(a[3*c+c]-a[3*e+e]-a[3*f+f]+1);b[c]=.5*d;d=.5/d;b[3]=(a[3*f+e]-a[3*e+f])*d;b[e]=(a[3*e+c]+a[3*c+e])*d;b[f]=(a[3*f+c]+a[3*c+f])*d}return b};C.toQuat4=n.fromRotationMatrix;(function(){var a=C.create();n.fromAxes=
  function(b,d,e,f){return a[0]=d[0],a[3]=d[1],a[6]=d[2],a[1]=e[0],a[4]=e[1],a[7]=e[2],a[2]=b[0],a[5]=b[1],a[8]=b[2],n.fromRotationMatrix(a,f)}})();n.identity=function(a){return a||(a=n.create()),a[0]=0,a[1]=0,a[2]=0,a[3]=1,a};n.fromAngleAxis=function(a,b,d){d||(d=n.create());a*=.5;var c=Math.sin(a);return d[3]=Math.cos(a),d[0]=c*b[0],d[1]=c*b[1],d[2]=c*b[2],d};n.toAngleAxis=function(a,c){c||(c=a);var d=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];0<d?(c[3]=2*Math.acos(a[3]),d=b.invsqrt(d),c[0]=a[0]*d,c[1]=a[1]*d,
  c[2]=a[2]*d):(c[3]=0,c[0]=1,c[1]=0,c[2]=0);return c};n.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};var q={create:function(a){var b=new e(2);return a?(b[0]=a[0],b[1]=a[1]):(b[0]=0,b[1]=0),b},createFrom:function(a,b){var c=new e(2);return c[0]=a,c[1]=b,c},add:function(a,b,d){return d||(d=b),d[0]=a[0]+b[0],d[1]=a[1]+b[1],d},subtract:function(a,b,d){return d||(d=b),d[0]=a[0]-b[0],d[1]=a[1]-b[1],d},multiply:function(a,b,d){return d||(d=b),d[0]=a[0]*b[0],d[1]=a[1]*b[1],d},divide:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               b,d){return d||(d=b),d[0]=a[0]/b[0],d[1]=a[1]/b[1],d},scale:function(a,b,d){return d||(d=a),d[0]=a[0]*b,d[1]=a[1]*b,d},dist:function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)},set:function(a,b){return b[0]=a[0],b[1]=a[1],b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])},negate:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b},normalize:function(a,b){b||(b=a);var c=a[0]*a[0]+a[1]*a[1];return 0<c?(c=Math.sqrt(c),b[0]=a[0]/c,b[1]=a[1]/c):b[0]=
  b[1]=0,b},cross:function(a,b,d){a=a[0]*b[1]-a[1]*b[0];return d?(d[0]=d[1]=0,d[2]=a,d):a},length:function(a){var b=a[0];a=a[1];return Math.sqrt(b*b+a*a)},squaredLength:function(a){var b=a[0];a=a[1];return b*b+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]},direction:function(a,b,d){d||(d=a);var c=a[0]-b[0];a=a[1]-b[1];return(b=c*c+a*a)?(b=1/Math.sqrt(b),d[0]=c*b,d[1]=a*b,d):(d[0]=0,d[1]=0,d[2]=0,d)},lerp:function(a,b,d,e){return e||(e=a),e[0]=a[0]+d*(b[0]-a[0]),e[1]=a[1]+d*(b[1]-a[1]),e},str:function(a){return"["+
  a[0]+", "+a[1]+"]"}},R={create:function(a){var b=new e(4);return a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):b[0]=b[1]=b[2]=b[3]=0,b},createFrom:function(a,b,d,f){var c=new e(4);return c[0]=a,c[1]=b,c[2]=d,c[3]=f,c},set:function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])&&1E-6>Math.abs(a[3]-b[3])},identity:function(a){return a||(a=R.create()),a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},transpose:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        b){if(!b||a===b){var c=a[1];return a[1]=a[2],a[2]=c,a}return b[0]=a[0],b[1]=a[2],b[2]=a[1],b[3]=a[3],b},determinant:function(a){return a[0]*a[3]-a[2]*a[1]},inverse:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],h=c*f-e*d;return h?(h=1/h,b[0]=f*h,b[1]=-d*h,b[2]=-e*h,b[3]=c*h,b):null},multiply:function(a,b,d){d||(d=a);var c=a[0],e=a[1],g=a[2];a=a[3];return d[0]=c*b[0]+e*b[2],d[1]=c*b[1]+e*b[3],d[2]=g*b[0]+a*b[2],d[3]=g*b[1]+a*b[3],d},rotate:function(a,b,d){d||(d=a);var c=a[0],e=a[1],g=a[2];
  a=a[3];var f=Math.sin(b);b=Math.cos(b);return d[0]=c*b+e*f,d[1]=c*-f+e*b,d[2]=g*b+a*f,d[3]=g*-f+a*b,d},multiplyVec2:function(a,b,d){d||(d=b);var c=b[0];b=b[1];return d[0]=c*a[0]+b*a[1],d[1]=c*a[2]+b*a[3],d},scale:function(a,b,d){d||(d=a);var c=a[1],e=a[2],g=a[3],f=b[0];b=b[1];return d[0]=a[0]*f,d[1]=c*b,d[2]=e*f,d[3]=g*b,d},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"}},t={};return t.create=function(a){var b=new e(4);return a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):(b[0]=0,b[1]=
  0,b[2]=0,b[3]=0),b},t.createFrom=function(a,b,d,f){var c=new e(4);return c[0]=a,c[1]=b,c[2]=d,c[3]=f,c},t.add=function(a,b,d){return d||(d=b),d[0]=a[0]+b[0],d[1]=a[1]+b[1],d[2]=a[2]+b[2],d[3]=a[3]+b[3],d},t.subtract=function(a,b,d){return d||(d=b),d[0]=a[0]-b[0],d[1]=a[1]-b[1],d[2]=a[2]-b[2],d[3]=a[3]-b[3],d},t.multiply=function(a,b,d){return d||(d=b),d[0]=a[0]*b[0],d[1]=a[1]*b[1],d[2]=a[2]*b[2],d[3]=a[3]*b[3],d},t.divide=function(a,b,d){return d||(d=b),d[0]=a[0]/b[0],d[1]=a[1]/b[1],d[2]=a[2]/b[2],
  d[3]=a[3]/b[3],d},t.scale=function(a,b,d){return d||(d=a),d[0]=a[0]*b,d[1]=a[1]*b,d[2]=a[2]*b,d[3]=a[3]*b,d},t.set=function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},t.equal=function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])&&1E-6>Math.abs(a[3]-b[3])},t.negate=function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},t.length=function(a){var b=a[0],d=a[1],e=a[2];a=a[3];return Math.sqrt(b*b+d*d+e*e+a*a)},t.squaredLength=
  function(a){var b=a[0],d=a[1],e=a[2];a=a[3];return b*b+d*d+e*e+a*a},t.lerp=function(a,b,d,e){return e||(e=a),e[0]=a[0]+d*(b[0]-a[0]),e[1]=a[1]+d*(b[1]-a[1]),e[2]=a[2]+d*(b[2]-a[2]),e[3]=a[3]+d*(b[3]-a[3]),e},t.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"},h&&(h.glMatrixArrayType=e,h.MatrixArray=e,h.setMatrixArrayType=l,h.determineMatrixArrayType=u,h.glMath=b,h.vec2=q,h.vec3=d,h.vec4=t,h.mat2=R,h.mat3=C,h.mat4=r,h.quat4=n),{glMatrixArrayType:e,MatrixArray:e,setMatrixArrayType:l,
  determineMatrixArrayType:u,glMath:b,vec2:q,vec3:d,vec4:t,mat2:R,mat3:C,mat4:r,quat4:n}});
define("compute",["require","exports","module"],function(h,l,u){function b(b,d){this.gl=b;this.shader=d.shader;this.mesh=d.mesh;this.uniforms=d.uniforms;this.outputFBO=d.output;this.blend=d.blend;this.nobind=d.nobind;this.nounbind=d.nounbind}b.prototype.run=function(){this.outputFBO&&!this.nobind&&this.outputFBO.bind();var b=0,d,f;for(f in this.uniforms)this.uniforms.hasOwnProperty(f)&&(d=this.uniforms[f],d.bindTexture&&!d.bound&&d.bindTexture(b++));this.shader.use();this.shader.uniforms(this.uniforms);
  "add"===this.blend?(this.gl.blendFunc(gl.SRC_ALPHA,gl.ONE),this.gl.enable(gl.BLEND)):this.gl.disable(gl.BLEND);this.mesh.draw(this.shader);this.outputFBO&&!this.nounbind&&this.outputFBO.unbind();for(f in this.uniforms)this.uniforms.hasOwnProperty(f)&&(d=this.uniforms[f],d.bindTexture&&d.bound&&d.unbindTexture())};l.Kernel=b});
define("main","require exports module game-shim engine/loader engine/clock engine/input engine/utils engine/gl/shader engine/gl/geometry engine/gl/texture engine/gl/mesh engine/gl/context gl-matrix compute".split(" "),function(h,l,u){h("game-shim");var b=h("engine/loader"),e=h("engine/clock").Clock,d=h("engine/input").Handler,f=h("engine/utils").debounce,m=h("engine/gl/shader").Manager,k=h("engine/gl/geometry"),H=h("engine/gl/texture").FBO,Q=h("engine/gl/mesh").Mesh,D=h("engine/gl/context"),C=h("gl-matrix"),
  r=h("compute").Kernel;h=function(){var h=function(a){this.options=a||{};this.x=this.options.x||0;this.y=this.options.y||0;this.px=this.options.px||0;this.py=this.options.py||0;this.size=this.options.size||1;this.dt=this.options.dt||0;this.update=this.options.update||function(){}},l=document.getElementById("liquid"),q=D.initialize(l,{context:{depth:!1},debug:!1,extensions:{texture_float:!0}},this.fail),u=1/30,t=new e(l),a=new d(l),c=new b,g=new m(q,c.resources),p=0,z=0,O=navigator.userAgent.toLowerCase(),
  w=/mobile|android|ip(ad|od|hone)|windows phone/.test(O),E=C.vec2,P;window.gl=q;var L=function(){q&&c.load("/js/liquid/shaders/advect.frag /js/liquid/shaders/addForce.frag /js/liquid/shaders/divergence.frag /js/liquid/shaders/jacobi.frag /js/liquid/shaders/subtractPressureGradient.frag /js/liquid/shaders/visualize.frag /js/liquid/shaders/cursor.vertex /js/liquid/shaders/boundary.vertex /js/liquid/shaders/kernel.vertex".split(" "),function(a){return function(){return a.init()}}(this))};return L.prototype.fail=
  function(a,b,c){document.getElementById("video").style.display="block"},L.prototype.hasFloatLuminanceFBOSupport=function(){return(new H(q,32,32,P,q.LUMINANCE)).supported},L.prototype.init=function(){q.getExtension("OES_texture_float_linear");if(w){var a=q.getExtension("OES_texture_half_float");a?P=a.HALF_FLOAT_OES:P=q.FLOAT}else P=q.FLOAT;window.addEventListener("resize",f(this.resize,250));this.resize()},L.prototype.resize=function(){var b=l.getBoundingClientRect();p=.35*b.width;z=.35*b.height;a.updateOffset();
  L.prototype.setup(p,z,void 0);w&&(l.setAttribute("style","width:99.8%"),setTimeout(function(){l.setAttribute("style","width:100%")},10))},L.prototype.setup=function(b,c,d){l.width=b;l.height=c;var e=.25;w&&(e=.15);q.viewport(0,0,b,c);q.lineWidth(1);var f=1/l.width,m=1/l.height,n=E.create([f,m]),p=E.create([1,l.width/l.height]),x=new Q(q,{vertex:k.screen_quad(1-2*f,1-2*m),attributes:{position:{}}}),z=new Q(q,{vertex:k.screen_quad(1,1),attributes:{position:{}}}),C=new Q(q,{mode:q.LINES,vertex:new Float32Array([-1+
    0*f,-1+0*m,-1+0*f,-1+2*m,1-0*f,-1+0*m,1-0*f,-1+2*m,-1+0*f,1-0*m,-1+0*f,1-2*m,1-0*f,1-0*m,1-0*f,1-2*m,-1+0*f,1-0*m,-1+2*f,1-0*m,-1+0*f,-1+0*m,-1+2*f,-1+0*m,1-0*f,1-0*m,1-2*f,1-0*m,1-0*f,-1+0*m,1-2*f,-1+0*m]),attributes:{position:{size:2,stride:16,offset:0},offset:{size:2,stride:16,offset:8}}}),A=new H(q,b,c,P),D=new H(q,b,c,P),L=new H(q,b,c,P,d),G=new H(q,b,c,P,d),J=new H(q,b,c,P,d),K=new r(q,{shader:g.get("kernel","advect"),mesh:x,uniforms:{px:n,px1:p,scale:1,velocity:A,source:A,dt:u},output:D}),
  O=new r(q,{shader:g.get("boundary","advect"),mesh:C,uniforms:{px:n,scale:-1,velocity:A,source:A,dt:1/60},output:D});d=new Q(q,{vertex:k.screen_quad(60*f,60*m),attributes:{position:{}}});var I=new r(q,{shader:g.get("cursor","addForce"),mesh:d,blend:"add",uniforms:{px:n,force:E.create([.5,.2]),center:E.create([.1,.4]),scale:E.create([30*f,30*m])},output:D}),M=new r(q,{shader:g.get("kernel","divergence"),mesh:z,uniforms:{velocity:D,px:n},output:L}),N=new r(q,{shader:g.get("kernel","jacobi"),mesh:z,nounbind:!0,
  uniforms:{pressure:G,divergence:L,alpha:-1,beta:.25,px:n},output:J}),F=new r(q,{shader:g.get("boundary","jacobi"),mesh:C,nounbind:!0,nobind:!0,uniforms:{pressure:G,divergence:L,alpha:-1,beta:e,px:n},output:J}),R=new r(q,{shader:g.get("kernel","subtractPressureGradient"),mesh:z,uniforms:{scale:1,pressure:G,velocity:D,px:n},output:A}),S=new r(q,{shader:g.get("boundary","subtractPressureGradient"),mesh:C,uniforms:{scale:-1,pressure:G,velocity:D,px:n},output:A}),Z=new r(q,{shader:g.get("kernel","visualize"),
  mesh:z,uniforms:{velocity:A,pressure:G,px:n,redMax:.95,redMin:.1,redRate:1,greenMax:.95,greenMin:.1,greenRate:1,blueMax:.95,blueMin:.1,blueRate:1},output:null}),X=2*Math.PI,e=Math.random()*b,n=Math.random()*c,W=1;w&&(W=.6);var Y=[new h({update:function(b){this.x=.35*a.mouse.x;this.y=.35*a.mouse.y}}),new h({dt:Math.random()*X,x:e,y:n,px:e,py:n,vecx:1,vecy:1,update:function(a){this.x+=this.options.vecx;this.y+=Math.sin(this.dt)*this.options.vecy;this.size=Math.abs(Math.cos(this.dt))*W;this.dt=(this.dt+
  .1*a)%X*W;0>this.x?(this.x=0,this.options.vecx=1):this.x>b&&(this.x=b,this.options.vecx=-1);0>this.y?(this.y=0,this.options.vecy=1):this.y>c&&(this.y=c,this.options.vecy=-1)}})];t.ontick=function(a){K.uniforms.dt=u;K.run();E.set([30*f,30*m],I.uniforms.scale);for(var b=0,c=Y.length;b<c;b++){var d=Y[b];d.update(a);if(0!==d.x||0!==d.y)E.set([(d.x-d.px)*f*30*d.size,-(d.y-d.py)*m*30*d.size],I.uniforms.force),E.set([d.x*f*2-1,-1*(d.y*m*2-1)],I.uniforms.center),I.run(),d.px=d.x,d.py=d.y}O.run();M.run();
  a=G;c=J;for(b=0;10>b;b++)N.uniforms.pressure=F.uniforms.pressure=a,N.outputFBO=F.outputFBO=c,N.run(),F.run(),d=a,a=c,c=d;R.run();S.run();Z.run()}},L.prototype.start=function(){t.start();a.addEvent()},L.prototype.stop=function(){t.stop();a.removeEvent()},L}();window.picsLiquid=h});require(["main"]);